/**
 * åé€šé€Ÿè¾¾ - æ•°æ®åº“å…¨è‡ªåŠ¨ç”Ÿæˆå™¨
 * ä½œç”¨ï¼šä¿®å¤ç¯å¢ƒ -> å†™å…¥é…ç½® -> ç”Ÿæˆ dev.db æ•°æ®æ–‡ä»¶
 */
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// è·¯å¾„å®šä¹‰
const rootDir = __dirname;
const dbDir = path.join(rootDir, 'packages/database');
const prismaDir = path.join(dbDir, 'prisma');

console.log('ğŸš€ å¼€å§‹å…¨è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“æ–‡ä»¶...');

// 1. å¼ºåˆ¶é‡å†™ schema.prisma (ç¡®ä¿æ˜¯ SQLite ä¸”åŒ…å« ProxyOrder)
if (!fs.existsSync(prismaDir)) fs.mkdirSync(prismaDir, { recursive: true });

const schemaContent = `
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ä»£ä»˜è®¢å•æ¨¡å‹
model ProxyOrder {
  id        String   @id @default(uuid())
  url       String
  amount    Decimal
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
}

// é¢„ç•™çš„ç”¨æˆ·æ¨¡å‹
model User {
  id    String @id @default(uuid())
  email String @unique
  name  String?
}
`;
fs.writeFileSync(path.join(prismaDir, 'schema.prisma'), schemaContent);
console.log('âœ… é…ç½®æ–‡ä»¶ schema.prisma å·²ä¿®å¤');

// 2. å¼ºåˆ¶å†™å…¥ .env æ–‡ä»¶
fs.writeFileSync(path.join(dbDir, '.env'), 'DATABASE_URL="file:./dev.db"');
console.log('âœ… ç¯å¢ƒå˜é‡ .env å·²ä¿®å¤');

// 3. è‡ªåŠ¨æ‰§è¡Œå‘½ä»¤ (æœ€å…³é”®çš„ä¸€æ­¥)
try {
  console.log('\nğŸ“¦ æ­£åœ¨å®‰è£…å¿…è¦çš„å·¥å…· (pnpm install)...');
  // å¿½ç•¥ workspace è­¦å‘Šï¼Œå¼ºåˆ¶å®‰è£…
  execSync('pnpm install', { stdio: 'inherit', cwd: rootDir });

  console.log('\nğŸ”„ æ­£åœ¨ç”Ÿæˆ Prisma å®¢æˆ·ç«¯ (prisma generate)...');
  execSync('npx prisma generate', { stdio: 'inherit', cwd: dbDir });

  console.log('\nğŸ’¾ æ­£åœ¨ç”Ÿæˆæ•°æ®æ–‡ä»¶ (db:push)...');
  // è¿™é‡Œä½¿ç”¨ npx ç¡®ä¿è°ƒç”¨çš„æ˜¯é¡¹ç›®å†…çš„ prisma
  execSync('npx prisma db push', { stdio: 'inherit', cwd: dbDir });

  console.log('\nğŸ‰ ===========================================');
  console.log('ğŸ‰ æˆåŠŸäº†ï¼dev.db æ–‡ä»¶å·²ç”Ÿæˆï¼');
  console.log('ğŸ‰ ç°åœ¨ä½ å¯ä»¥ç›´æ¥è¿è¡Œ pnpm dev å¯åŠ¨é¡¹ç›®äº†');
  console.log('ğŸ‰ ===========================================');

} catch (error) {
  console.error('\nâŒ ç”Ÿæˆå¤±è´¥:', error.message);
  console.error('å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼Œè¯·æ£€æŸ¥ä½ çš„ç½‘ç»œæ˜¯å¦èƒ½ä¸‹è½½ npm åŒ…ã€‚');
}