// ============================================
// 叁通速達 - 跨境大件家具垂直電商平台
// 含代理分銷系統 + 積分錢包 + 裝櫃管理
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 枚舉定義
// ============================================

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  COMPLETED
  REJECTED
}

enum PackageStatus {
  PREDICTED
  IN_WAREHOUSE
  PACKED
  SHIPPED
  DELIVERED
}

// 精細化物流狀態
enum LogisticsStatus {
  WAREHOUSE_IN      // 已入庫
  LOADED            // 已裝櫃
  SHIPPED           // 已發船
  ARRIVED_PORT      // 已到港
  CUSTOMS_CLEAR     // 清關中
  DISPATCHING       // 派送中
  DELIVERED         // 已簽收
}

enum ProductCategory {
  SOFA
  BED
  TABLE
  CHAIR
  CABINET
  OTHER
}

enum CommissionType {
  ORDER       // 商城訂單返點
  SHIPPING    // 運費返點
  BONUS       // 額外獎勵
  WITHDRAWAL  // 提現 (負數)
}

// 積分變動類型
enum PointLogType {
  ORDER_REWARD    // 訂單獎勵
  ORDER_DEDUCT    // 訂單抵扣
  ADMIN_ADJUST    // 管理員調整
  REFUND          // 退款返還
  REVIEW_REWARD   // 評價獎勵
}

// 集裝箱狀態
enum ContainerStatus {
  LOADING       // 裝櫃中
  SEALED        // 已封櫃
  SHIPPED       // 已發船
  ARRIVED       // 已到港
  CLEARED       // 已清關
  COMPLETED     // 已完成
}

// ============================================
// 用戶表 (含代理商字段 + 積分錢包)
// ============================================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(USER)
  balance   Decimal  @default(0) @db.Decimal(12, 2)
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================
  // 積分錢包系統
  // ============================================
  points    Int      @default(0)  // 積分餘額

  // ============================================
  // 代理分銷系統字段
  // ============================================
  isAgent           Boolean  @default(false)
  agentCode         String?  @unique
  agentName         String?
  referrerId        String?
  commissionBalance Decimal  @default(0) @db.Decimal(12, 2)
  commissionRate    Decimal  @default(0.05) @db.Decimal(4, 2)
  agentAppliedAt    DateTime?
  agentApprovedAt   DateTime?

  // 關聯
  orders            ProxyOrder[]
  packages          Package[]
  referrer          User?             @relation("Referrals", fields: [referrerId], references: [id])
  referrals         User[]            @relation("Referrals")
  commissionRecords CommissionRecord[] @relation("AgentCommissions")
  pointLogs         PointLog[]        // 積分記錄
  reviews           Review[]          // 用戶評價

  @@index([isAgent])
  @@index([agentCode])
  @@index([referrerId])
  @@map("users")
}

// ============================================
// 積分記錄表
// ============================================
model PointLog {
  id          String       @id @default(cuid())
  userId      String
  amount      Int                               // 變動數量 (正/負)
  type        PointLogType                      // 變動類型
  description String?                           // 描述
  orderId     String?                           // 關聯訂單ID
  balanceAfter Int                              // 操作後餘額
  createdAt   DateTime     @default(now())

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("point_logs")
}

// ============================================
// 佣金記錄表
// ============================================
model CommissionRecord {
  id          String         @id @default(cuid())
  agentId     String
  orderId     String?
  amount      Decimal        @db.Decimal(12, 2)
  type        CommissionType
  description String?
  balanceAfter Decimal       @db.Decimal(12, 2)
  createdAt   DateTime       @default(now())

  agent       User           @relation("AgentCommissions", fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([type])
  @@index([createdAt])
  @@map("commission_records")
}

// ============================================
// 系統配置表
// ============================================
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

// ============================================
// 代付訂單表 (含積分抵扣)
// ============================================
model ProxyOrder {
  id           String      @id @default(cuid())
  userId       String
  taobaoUrl    String
  rmbAmount    Decimal     @db.Decimal(12, 2)
  exchangeRate Decimal     @db.Decimal(6, 4)
  twdAmount    Decimal     @db.Decimal(12, 2)
  status       OrderStatus @default(PENDING)
  logs         String?
  remark       String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // 佣金已結算標記
  commissionPaid Boolean   @default(false)

  // 積分相關
  pointsUsed     Int       @default(0)  // 使用的積分
  pointsEarned   Int       @default(0)  // 獲得的積分

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("proxy_orders")
}

// ============================================
// 倉庫地址表
// ============================================
model Warehouse {
  id          String   @id @default(cuid())
  name        String
  contactName String
  phone       String
  province    String
  city        String
  district    String
  address     String
  postalCode  String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("warehouses")
}

// ============================================
// 包裹預報表 (含驗貨報告 + 精細物流軌跡)
// ============================================
model Package {
  id               String        @id @default(cuid())
  userId           String
  trackingNumber   String        @unique
  logisticsCompany String?
  description      String?
  weight           Decimal?      @db.Decimal(8, 2)
  volume           Decimal?      @db.Decimal(8, 4)
  quantity         Int           @default(1)
  status           PackageStatus @default(PREDICTED)
  remark           String?
  inboundAt        DateTime?
  shippedAt        DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // ============================================
  // 驗貨報告 (QC Report)
  // ============================================
  qcStatus         String?
  qcImages         String[]
  qcNote           String?
  isReinforced     Boolean       @default(false)
  qcAt             DateTime?

  // ============================================
  // 精細化物流軌跡
  // ============================================
  logisticsStatus  LogisticsStatus?  // 精細物流狀態
  containerId      String?           // 關聯集裝箱
  declaredValue    Decimal?     @db.Decimal(10, 2)  // 申報價值 (USD)

  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  container        Container?   @relation(fields: [containerId], references: [id])
  logisticsEvents  LogisticsEvent[]  // 物流事件記錄

  @@index([userId])
  @@index([status])
  @@index([qcStatus])
  @@index([containerId])
  @@index([logisticsStatus])
  @@map("packages")
}

// ============================================
// 物流事件記錄表 (軌跡時間線)
// ============================================
model LogisticsEvent {
  id          String          @id @default(cuid())
  packageId   String
  status      LogisticsStatus
  location    String?                           // 地點
  description String?                           // 描述
  operatorId  String?                           // 操作員ID
  createdAt   DateTime        @default(now())

  package     Package         @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@index([packageId])
  @@index([createdAt])
  @@map("logistics_events")
}

// ============================================
// 集裝箱表 (裝櫃管理)
// ============================================
model Container {
  id           String          @id @default(cuid())
  containerNo  String          @unique           // 櫃號 (如: MSKU1234567)
  vesselName   String?                           // 船名
  voyageNo     String?                           // 航次
  etd          DateTime?                         // 預計離港時間
  eta          DateTime?                         // 預計到港時間
  atd          DateTime?                         // 實際離港時間
  ata          DateTime?                         // 實際到港時間
  status       ContainerStatus @default(LOADING)
  totalWeight  Decimal?        @db.Decimal(10, 2)  // 總重量 (kg)
  totalVolume  Decimal?        @db.Decimal(10, 4)  // 總體積 (CBM)
  totalPieces  Int             @default(0)         // 總件數
  remark       String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  packages     Package[]       // 櫃內包裹

  @@index([status])
  @@index([eta])
  @@map("containers")
}

// ============================================
// 商品表 (家具商城核心 - Costco模式定價)
// ============================================
model Product {
  id          String          @id @default(cuid())
  title       String
  description String?         @db.Text
  price       Decimal         @db.Decimal(12, 2)

  images      String[]
  category    ProductCategory @default(OTHER)

  // 物流參數
  length      Int?
  width       Int?
  height      Int?
  weight      Decimal?        @db.Decimal(8, 2)
  volume      Decimal?        @db.Decimal(8, 4)

  // Costco 模式定價參數
  costRmb               Decimal?  @db.Decimal(12, 2)
  internalShippingCost  Decimal?  @db.Decimal(10, 2)
  marginRate            Decimal?  @db.Decimal(4, 2)

  // 營銷屬性
  isFreeShipping Boolean      @default(true)
  stock          Int          @default(0)
  isActive       Boolean      @default(true)
  isFeatured     Boolean      @default(false)
  sortOrder      Int          @default(0)

  // 代理佣金比例
  commissionRate Decimal?     @db.Decimal(4, 2)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([category])
  @@index([isActive, isFeatured])
  @@index([sortOrder])
  @@map("products")
}

// ============================================
// 物流規則表
// ============================================
model LogisticsRule {
  id            String   @id @default(cuid())
  name          String
  code          String   @unique
  pricePerCbm   Decimal  @db.Decimal(10, 2)
  pricePerKg    Decimal? @db.Decimal(10, 2)
  minCharge     Decimal  @default(0) @db.Decimal(10, 2)
  estimatedDays Int?
  description   String?
  isActive      Boolean  @default(true)
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("logistics_rules")
}

// ============================================
// 買家評價表 (口碑展示系統)
// ============================================
model Review {
  id          String   @id @default(cuid())
  userId      String
  orderId     String   @unique               // 一個訂單只能評價一次
  productId   String?                        // 關聯商品 (可選)
  rating      Int                            // 1-5 星評分
  content     String?  @db.Text              // 評價文字
  images      String[]                       // 買家秀圖片 URL 數組
  isFeatured  Boolean  @default(false)       // 精選標記 (首頁輪播)
  reply       String?  @db.Text              // 管理員回復
  repliedAt   DateTime?                      // 回復時間
  productName String?                        // 冗餘：購買商品名稱 (用於展示)
  isAnonymous Boolean  @default(false)       // 匿名評價
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isFeatured])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}
