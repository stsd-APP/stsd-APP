/**
 * åé€šé€Ÿè¾¾ v2.0 - å…¨æ ˆæ ¸å¿ƒåŠŸèƒ½å‡çº§è„šæœ¬
 * åŒ…å«ï¼šåç«¯ API éª¨æ¶ã€å‰ç«¯å¤šè¯­è¨€ã€ä»£ä»˜åŠŸèƒ½ã€å•†åŸé¡µé¢
 */
const fs = require('fs');
const path = require('path');

// è¾…åŠ©å‡½æ•°ï¼šç¡®ä¿ç›®å½•å­˜åœ¨
function ensureDir(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
}

// è¾…åŠ©å‡½æ•°ï¼šå†™å…¥æ–‡ä»¶
function writeFile(filePath, content) {
  ensureDir(path.dirname(filePath));
  fs.writeFileSync(filePath, content);
  console.log(`âœ… å·²æ›´æ–°: ${filePath}`);
}

// === 1. åç«¯ (NestJS) æ ¸å¿ƒæ¨¡å— ===
const apiRoot = path.join(__dirname, 'apps/api/src');

// (A) åç«¯å…¥å£ä¸å¤šè¯­è¨€ä¸­é—´ä»¶
writeFile(path.join(apiRoot, 'main.ts'), `
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { PrismaService } from './prisma.service';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // å…è®¸è·¨åŸŸï¼ˆæ–¹ä¾¿å‰ç«¯è°ƒç”¨ï¼‰
  app.enableCors();
  
  const prisma = app.get(PrismaService);
  await prisma.enableShutdownHooks(app);

  await app.listen(3000);
  console.log('ğŸš€ Server running on http://localhost:3000');
}
bootstrap();
`);

writeFile(path.join(apiRoot, 'app.module.ts'), `
import { Module } from '@nestjs/common';
import { PrismaService } from './prisma.service';
import { AppController } from './app.controller';

@Module({
  imports: [],
  controllers: [AppController],
  providers: [PrismaService],
})
export class AppModule {}
`);

writeFile(path.join(apiRoot, 'prisma.service.ts'), `
import { Injectable, OnModuleInit, INestApplication } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }

  async enableShutdownHooks(app: INestApplication) {
    this.$on('beforeExit', async () => {
      await app.close();
    });
  }
}
`);

// (B) æ ¸å¿ƒæ§åˆ¶å™¨ (é›†è¿ã€ä»£ä»˜ã€å•†åŸ)
writeFile(path.join(apiRoot, 'app.controller.ts'), `
import { Controller, Get, Post, Body, Query } from '@nestjs/common';
import { PrismaService } from './prisma.service';

@Controller('api')
export class AppController {
  constructor(private readonly prisma: PrismaService) {}

  @Get('hello')
  getHello(): string {
    return 'ThreeLinks API v2.0 Online';
  }

  // æ¨¡æ‹Ÿæäº¤é›†è¿åŒ…è£¹
  @Post('package/add')
  async addPackage(@Body() data: any) {
    return { code: 200, msg: 'åŒ…è£¹é¢„æŠ¥æˆåŠŸ', data };
  }

  // æ¨¡æ‹Ÿä»£ä»˜ç”³è¯·
  @Post('proxy-pay/add')
  async addProxyPay(@Body() data: any) {
    return { code: 200, msg: 'ä»£ä»˜ç”³è¯·å·²æäº¤', data };
  }
}
`);

// === 2. å‰ç«¯ (Vue3) å¤šè¯­è¨€ä¸é¡µé¢ ===
const webRoot = path.join(__dirname, 'apps/web/src');

// (A) å¤šè¯­è¨€é…ç½® (i18n)
writeFile(path.join(webRoot, 'locales/zh-TW.json'), JSON.stringify({
  tabbar: { home: "é¦–é ", logistics: "é›†é‹", mall: "å•†åŸ", mine: "æˆ‘çš„" },
  home: { title: "åé€šé€Ÿé”", subtitle: "æ‚¨å°ˆæ¥­çš„è·¨å¢ƒç‰©æµç®¡å®¶", tracking: "æœ€æ–°åŒ…è£¹å‹•æ…‹", mall_hot: "å„ªé¸å•†åŸ" },
  func: { forecast: "é›†é‹é å ±", query: "åŒ…è£¹æŸ¥è©¢", estimate: "é‹è²»ä¼°ç®—", proxy: "ä»£ä»˜ç”³è«‹" },
  proxy: { title: "ä»£ä»˜ç”³è«‹", url_label: "å•†å“éˆæ¥", url_ph: "è«‹ç²˜è²¼æ·˜å¯¶/1688éˆæ¥", amount_label: "ä»£ä»˜é‡‘é¡(CNY)", submit: "æäº¤ç”³è«‹" },
  mall: { title: "å„ªé¸å•†åŸ", cart: "è³¼ç‰©è»Š" }
}, null, 2));

writeFile(path.join(webRoot, 'locales/zh-CN.json'), JSON.stringify({
  tabbar: { home: "é¦–é¡µ", logistics: "é›†è¿", mall: "å•†åŸ", mine: "æˆ‘çš„" },
  home: { title: "åé€šé€Ÿè¾¾", subtitle: "æ‚¨ä¸“ä¸šçš„è·¨å¢ƒç‰©æµç®¡å®¶", tracking: "æœ€æ–°åŒ…è£¹åŠ¨æ€", mall_hot: "ä¼˜é€‰å•†åŸ" },
  func: { forecast: "é›†è¿é¢„æŠ¥", query: "åŒ…è£¹æŸ¥è¯¢", estimate: "è¿è´¹ä¼°ç®—", proxy: "ä»£ä»˜ç”³è¯·" },
  proxy: { title: "ä»£ä»˜ç”³è¯·", url_label: "å•†å“é“¾æ¥", url_ph: "è¯·ç²˜è´´æ·˜å®/1688é“¾æ¥", amount_label: "ä»£ä»˜é‡‘é¢(CNY)", submit: "æäº¤ç”³è¯·" },
  mall: { title: "ä¼˜é€‰å•†åŸ", cart: "è´­ç‰©è½¦" }
}, null, 2));

writeFile(path.join(webRoot, 'locales/en.json'), JSON.stringify({
  tabbar: { home: "Home", logistics: "Shipping", mall: "Mall", mine: "Me" },
  home: { title: "ThreeLinks", subtitle: "Cross-border Logistics Expert", tracking: "Recent Packages", mall_hot: "Hot Sales" },
  func: { forecast: "Forecast", query: "Tracking", estimate: "Calculator", proxy: "Proxy Pay" },
  proxy: { title: "Proxy Payment", url_label: "Product URL", url_ph: "Paste Taobao/1688 URL", amount_label: "Amount (CNY)", submit: "Submit" },
  mall: { title: "Shop", cart: "Cart" }
}, null, 2));

writeFile(path.join(webRoot, 'i18n.ts'), `
import { createI18n } from 'vue-i18n'
import zhTW from './locales/zh-TW.json'
import zhCN from './locales/zh-CN.json'
import en from './locales/en.json'

const i18n = createI18n({
  legacy: false,
  locale: localStorage.getItem('lang') || 'zh-TW', // é»˜è®¤ç¹ä½“
  fallbackLocale: 'en',
  messages: {
    'zh-TW': zhTW,
    'zh-CN': zhCN,
    'en': en
  }
})

export default i18n
`);

// (B) æ›´æ–° main.ts å¼•å…¥ i18n
writeFile(path.join(webRoot, 'main.ts'), `
import { createApp } from 'vue'
import 'virtual:uno.css'
import 'vant/lib/index.css'
import { Tabbar, TabbarItem, Button, Card, Tag, Icon, Field, CellGroup, Form, NavBar, Popup, ActionSheet } from 'vant'
import App from './App.vue'
import i18n from './i18n'

const app = createApp(App)
app.use(i18n)
app.use(Tabbar).use(TabbarItem).use(Button).use(Card).use(Tag).use(Icon)
   .use(Field).use(CellGroup).use(Form).use(NavBar).use(Popup).use(ActionSheet)
app.mount('#app')
`);

// (C) æ ¸å¿ƒé¡µé¢é€»è¾‘ (App.vue - æ•´åˆæ‰€æœ‰åŠŸèƒ½)
writeFile(path.join(webRoot, 'App.vue'), `
<script setup lang="ts">
import { ref } from 'vue'
import { useI18n } from 'vue-i18n'
import { showToast } from 'vant'

const { t, locale } = useI18n()
const active = ref(0) // 0:Home, 1:Logistics, 2:Mall, 3:Mine

// è¯­è¨€åˆ‡æ¢
const showLang = ref(false)
const langActions = [
  { name: 'ç¹é«”ä¸­æ–‡', value: 'zh-TW' },
  { name: 'ç®€ä½“ä¸­æ–‡', value: 'zh-CN' },
  { name: 'English', value: 'en' },
]
const onSelectLang = (item) => {
  locale.value = item.value
  localStorage.setItem('lang', item.value)
  showLang.value = false
}

// === åŠŸèƒ½æ¨¡å—çŠ¶æ€ ===
const showProxyPay = ref(false) // ä»£ä»˜å¼¹çª—
const proxyForm = ref({ url: '', amount: '' })

const onSubmitProxy = () => {
  showToast({ type: 'success', message: t('proxy.submit') + ' Success!' })
  showProxyPay.value = false
}

// æ¨¡æ‹ŸåŒ…è£¹æ•°æ®
const packages = ref([
  { id: 'SF10086', name: 'æ·˜å®é›†è¿ä»“', status: 'ARRIVED', date: '2024-01-21' }
])

// æ¨¡æ‹Ÿå•†åŸæ•°æ®
const products = ref([
  { id: 1, title: 'ç°ä»£ç®€çº¦å¸ƒè‰ºæ²™å‘', price: 1299, img: 'bg-gray-200' },
  { id: 2, title: 'å®æœ¨é¤æ¡Œç»„åˆ', price: 899, img: 'bg-gray-200' },
  { id: 3, title: 'å…¨å±‹å®šåˆ¶è¡£æŸœ', price: 3500, img: 'bg-gray-200' },
  { id: 4, title: 'æ™ºèƒ½å‡é™èŒ¶å‡ ', price: 450, img: 'bg-gray-200' }
])
</script>

<template>
  <div class="pb-20 bg-gray-50 min-h-screen">
    
    <div v-if="active === 0">
      <div class="bg-brand text-white p-4 pt-12 rounded-b-xl shadow-lg relative">
        <div class="flex justify-between items-center z-10 relative">
          <div>
            <h1 class="text-xl font-bold">{{ t('home.title') }}</h1>
            <p class="text-xs opacity-80 mt-1">{{ t('home.subtitle') }}</p>
          </div>
          <div class="flex gap-2">
            <div @click="showLang = true" class="bg-white/20 px-2 py-1 rounded text-xs flex items-center">
              <div class="i-carbon-language mr-1"></div> {{ locale === 'zh-TW' ? 'ç¹' : (locale === 'en' ? 'EN' : 'ç®€') }}
            </div>
            <div class="bg-white/20 p-2 rounded-full"><div class="i-carbon-notification text-xl"></div></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-4 gap-2 p-4 -mt-6 relative z-20">
        <div class="bg-white p-3 rounded-lg shadow-sm flex flex-col items-center gap-2" 
             @click="item.key === 'proxy' ? showProxyPay = true : null"
             v-for="item in [
               {key:'forecast', icon:'delivery'}, 
               {key:'query', icon:'search'}, 
               {key:'estimate', icon:'calculator'}, 
               {key:'proxy', icon:'currency'}
             ]" :key="item.key">
          <div class="bg-blue-50 text-brand p-2 rounded-full text-xl">
             <div :class="\`i-carbon-\${item.icon}\`"></div>
          </div>
          <span class="text-xs text-gray-600">{{ t('func.' + item.key) }}</span>
        </div>
      </div>

      <div class="px-4 mt-2">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-bold text-gray-800">{{ t('home.tracking') }}</h2>
        </div>
        <div v-for="pkg in packages" :key="pkg.id" class="bg-white p-4 rounded-xl shadow-sm mb-3 border-l-4 border-brand flex justify-between">
          <div>
            <div class="font-bold">{{ pkg.name }}</div>
            <div class="text-xs text-gray-400 mt-1">{{ pkg.id }} | {{ pkg.date }}</div>
          </div>
          <van-tag type="primary" plain>{{ pkg.status }}</van-tag>
        </div>
      </div>

      <div class="px-4 mt-4">
         <h2 class="font-bold text-gray-800 mb-2">{{ t('home.mall_hot') }}</h2>
         <div class="grid grid-cols-2 gap-3">
            <div v-for="p in products.slice(0,2)" :key="p.id" class="bg-white rounded-lg p-2 shadow-sm">
               <div class="h-24 w-full bg-gray-200 rounded mb-2 flex items-center justify-center text-gray-400 text-xs">IMG</div>
               <div class="text-sm truncate">{{ p.title }}</div>
               <div class="text-red-600 font-bold mt-1">Â¥{{ p.price }}</div>
            </div>
         </div>
      </div>
    </div>

    <div v-if="active === 2" class="p-4 pt-12">
      <h1 class="text-xl font-bold mb-4">{{ t('mall.title') }}</h1>
      <div class="grid grid-cols-2 gap-3">
        <div v-for="p in products" :key="p.id" class="bg-white rounded-lg p-2 shadow-sm">
            <div class="h-32 w-full bg-gray-200 rounded mb-2 relative">
               <div class="absolute top-1 right-1 bg-white/80 p-1 rounded-full text-brand"><div class="i-carbon-shopping-cart-plus"></div></div>
            </div>
            <div class="text-sm line-clamp-2 h-10">{{ p.title }}</div>
            <div class="flex justify-between items-end mt-2">
              <span class="text-red-600 font-bold">Â¥{{ p.price }}</span>
              <span class="text-xs text-gray-400">Sold 100+</span>
            </div>
        </div>
      </div>
    </div>

    <van-popup v-model:show="showProxyPay" position="bottom" round :style="{ height: '50%' }">
      <div class="p-4">
        <h3 class="font-bold text-lg mb-4 text-center">{{ t('proxy.title') }}</h3>
        <van-form @submit="onSubmitProxy">
          <van-cell-group inset>
            <van-field v-model="proxyForm.url" :label="t('proxy.url_label')" :placeholder="t('proxy.url_ph')" />
            <van-field v-model="proxyForm.amount" type="number" :label="t('proxy.amount_label')" placeholder="0.00" />
          </van-cell-group>
          <div class="mt-6 px-4">
            <van-button block type="primary" native-type="submit" color="#1989fa">{{ t('proxy.submit') }}</van-button>
          </div>
        </van-form>
      </div>
    </van-popup>

    <van-action-sheet v-model:show="showLang" :actions="langActions" @select="onSelectLang" />

    <van-tabbar v-model="active" active-color="#1989fa" class="shadow-2xl">
      <van-tabbar-item icon="home-o">{{ t('tabbar.home') }}</van-tabbar-item>
      <van-tabbar-item icon="logistics">{{ t('tabbar.logistics') }}</van-tabbar-item>
      <van-tabbar-item icon="bag-o">{{ t('tabbar.mall') }}</van-tabbar-item>
      <van-tabbar-item icon="user-o">{{ t('tabbar.mine') }}</van-tabbar-item>
    </van-tabbar>
  </div>
</template>

<style>
/* è‡ªå®šä¹‰ Vant æ ·å¼è¦†ç›– */
:root { --van-tabbar-height: 60px; }
</style>
`);

console.log('âœ¨ å‡çº§è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼è¯·è¿è¡Œ pnpm install å®‰è£…æ–°ä¾èµ– (vue-i18n ç­‰)');